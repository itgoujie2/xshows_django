; Supervisor configuration for XShows Django project (EC2 Production)
; To run: supervisord -c supervisord.ec2.conf
; To control: supervisorctl -c supervisord.ec2.conf status

[unix_http_server]
file=/var/www/xshows/supervisor.sock

[supervisord]
logfile=/var/www/xshows/logs/supervisord.log
logfile_maxbytes=10MB
logfile_backups=3
loglevel=info
pidfile=/var/www/xshows/supervisord.pid
nodaemon=false

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/www/xshows/supervisor.sock

; ============================================
; Django Application (Gunicorn for production)
; ============================================
[program:xshows-django]
command=/var/www/xshows/venv/bin/gunicorn xshows.wsgi:application --bind 127.0.0.1:8000 --workers 2 --timeout 120
directory=/var/www/xshows
user=ec2-user
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/www/xshows/logs/django.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
environment=PATH="/var/www/xshows/venv/bin"

; ============================================
; Celery Worker (optimized for t3.small)
; ============================================
[program:xshows-celery-worker]
command=/var/www/xshows/venv/bin/celery -A xshows worker -l info --concurrency=2 --max-tasks-per-child=50
directory=/var/www/xshows
user=ec2-user
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/www/xshows/logs/celery-worker.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
environment=PATH="/var/www/xshows/venv/bin"
stopwaitsecs=600
stopasgroup=true
killasgroup=true
stopsignal=TERM

; ============================================
; Celery Beat (Scheduler)
; ============================================
[program:xshows-celery-beat]
command=/var/www/xshows/venv/bin/celery -A xshows beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
directory=/var/www/xshows
user=ec2-user
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/www/xshows/logs/celery-beat.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
environment=PATH="/var/www/xshows/venv/bin"
stopsignal=TERM

; ============================================
; Group for all xshows services
; ============================================
[group:xshows]
programs=xshows-django,xshows-celery-worker,xshows-celery-beat
priority=999
